# **SDK for Unity 5.6.x**

## **Table of Content**
* [1. Tools](#Tools)
* [2. Demo](#Demo)
* [3. Android Plugin](#Android-Plugin)
    * [3.1. Player Settings](#Player-Settings)
    * [3.2. Library](#Library)
    * [3.3. VTCSdk configuration](#VTCSdk-configuration)
    * [3.4. Android Manifest](#Android-Manifest)
    * [3.5. Gradle Build](#Gradle-Build)
    * [3.6. Export Project](#Export-Project)
* [4. Unity code](#Unity-code)
    * [4.1. SetEnvironment](#SetEnvironment)
    * [4.2. InitStartSDK](#InitStartSDK)
    * [4.3. IOnActivityResult](#IOnActivityResult)
    * [4.4. SignIn](#SignIn)
    * [4.5. SignOut](#SignOut)
* [5. Android Studio](#Android-Studio)
* [6. Q & A](#Q-&-A)

### <a name="Tools">1. Tools</a>

* [Unity **5.6.5p1**](https://unity3d.com/unity/qa/patch-releases/5.6.5p1)
* [Android Studio **3.5.2**](https://developer.android.com/studio)

### <a name="Demo">2. Demo</a>
Checkout Git: [https://github.com/lannes/sdk-unity.git](https://github.com/lannes/sdk-unity.git)

Open `sdkdemo` project in the Unity 5.6.x.

### <a name="Android-Plugin">3. Android Plugin</a>

* #### <a name="Player Settings">3.1. Player Settings</a>

    * Choose Minimum API Level: `Android 4.1 'Jelly Bean'`
    * Choose Target API Level: `Automatic (highest installed)`

    ![](Identification.png)

* #### <a name="Library">3.2. Library<a>
    * Copy 4 files: `AndroidManifest.xml`, `mainTemplate.gradle`, `unity.aar`, `VTCSdk.aar` into the `Assets/Plugins/Android` folder as the below image:

    ![](./plugin-android.png)
    
    * Copy [BuildPostProcessor.cs](./sdkdemo/Assets/Scripts/Editor/BuildPostProcessor.cs) into the `Scripts/Editor` folder.
    * Copy `NativeAssets` directory to the Unity project.
    * Folder structure:
    ```
    + Assest
    |   + Plugins
    |   |   + Android
    |   |   |   - AndroidManifest.xml
    |   |   |   - mainTemplate.gradle
    |   |   |   - unity.aar
    |   |   |   - VTCSdk.aar
    |   |   + iOS
    |   + Scripts
    |   |   + Editor
    |   |   |   - BuildPostProcessor.cs
    |   |   - SDKManager.cs
    + Library
    + NativeAssets
    |   + VtcSDK.framework
    |   + VtcSDKResource.bundle
    |   - VtcSDK-Info.plist
    |   - sdkconfig.xml
    + ProjectSettings
    ```

* #### <a name="VTCSdk-configuration">3.3. VTCSdk configuration</a>

    The `sdkconfig.xml` file in `NativeAssets` directory.

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <resources>
    sdk_facebook_app_id =
    sdk_google_client_id =
    sdk_google_client_secret =
    sdk_gcm_id =
    sdk_appsflyer_dev_key = 4toAa4UsXTiSELM98xse83
    sdk_client_id = 
    sdk_client_secret_key = 
    sdk_notification = one
    sdk_direct_download = no
    sdk_utm = 
    </resources>
    ```

    Please contact us to get the values below:
    * sdk_client_id
    * sdk_client_secret_key

    Set field values before use Unity to build Android project.

* #### <a name="Android-Manifest">3.4. Android Manifest</a>

    Use the template to override `AndroidManifest.xml` file generated by Unity.

    * File: [AndroidManifest.xml](./sdkdemo/Assets/Plugins/Android/AndroidManifest.xml)
    * _Reference link: [android-manifest](https://docs.unity3d.com/560/Documentation/Manual/android-manifest.html)_

* #### <a name="Gradle-Build">3.5. Gradle Build</a>

    Use the template to override `gradle.build` file generated by Unity.

    * File: [mainTemplate.gradle](./sdkdemo/Assets/Plugins/Android/mainTemplate.gradle)
    * _Reference link: [android-gradle-overview](https://docs.unity3d.com/560/Documentation/Manual/android-gradle-overview.html)_

    _Please without modify variables in the `**` symbols, else Unity will export the `build.gradle` file incorrect._

* #### <a name="Export-Project">3.6. Export Project</a>

    ![](./Android.png)

### <a name="Unity-code">4. Unity code</a>

Copy [SDKManager.cs](./sdkdemo/Assets/Scripts/SDKManager.cs) into the `Scripts` folder.

* #### <a name="SetEnvironment">4.1. SetEnvironment</a>
    ```cs
    SDKManager.SetEnvironment(SDKManager.ENVIRONMENT_SANDBOX);
    ```

    Environment
    * **Sandbox**: `SDKManager.ENVIRONMENT_SANDBOX`
    * **Live**: `SDKManager.ENVIRONMENT_LIVE`

* #### <a name="InitStartSDK">4.2. InitStartSDK</a>
    ```cs
    void StartSDK() {
        #if UNITY_ANDROID

        // Call before start SDK
        SDKManager.SetEnvironment(SDKManager.ENVIRONMENT_SANDBOX);

        using (AndroidJavaClass unityPlayer = new AndroidJavaClass("com.unity3d.player.UnityPlayer")) {
            using (AndroidJavaObject activity = unityPlayer.GetStatic<AndroidJavaObject>("currentActivity")) {
                SDKManager.InitStartSDK(activity);
            }
        }

        #endif
    }
    ```

* #### <a name="IOnActivityResult">4.3. IOnActivityResult</a>

    Implement `IOnActivityResult` interface to receive result from the `SDKManager.cs`.

    ```cs
    #if UNITY_ANDROID
    public class Main : MonoBehaviour, SDKManager.IOnActivityResult {
    #else
    public class Main : MonoBehaviour {
    #endif
        #if UNITY_ANDROID
        public void onMessage(string message, int requestCode) {

        }
        #endif

        // Use this for initialization
	    void Start () {
            StartSDK();
        }
        
        // Update is called once per frame
        void Update () {

        }
    }
    ```

* #### <a name="SignIn">4.4. SignIn</a>
    ```cs
    #if UNITY_ANDROID

    public void onMessage(string message, int requestCode) {
        if (requestCode == SDKManager.SIGNIN_CODE) {
            Debug.Log("ACCOUNT NAME: " + SDKManager.vtcUser.accountName);
            Debug.Log("ACCOUNT ID: " + SDKManager.vtcUser.accountId);
            Debug.Log("VCOIN BALANCE: " + SDKManager.vtcUser.vcoinBalance);

            // If you use VTC's payment please contact us to get more information.
            // SDKManager.UpdateGameInfo(id, data);
        }
    }

    #endif

    public void SignIn() {
        #if UNITY_ANDROID

        using (AndroidJavaClass unityPlayer = new AndroidJavaClass("com.unity3d.player.UnityPlayer")) {
            using (AndroidJavaObject activity = unityPlayer.GetStatic<AndroidJavaObject>("currentActivity")) {
                SDKManager.SignIn (activity, this);
            }
        }

        #endif
    }
    ```

* #### <a name="SignOut">4.5. SignOut<a>
    ```cs
    public void SignOut() {
        #if UNITY_ANDROID        
        SDKManager.SignOut();
        #endif
    }
    ```

### <a name="Android-Studio">5. Android Studio</a>

You need only open and build the Android project.

### <a name="Q-&-A">6. Q & A</a>

1. **Q:** Why need export to Android project?

    VTCSdk library need new version of gradle with more features than version 2.1.0 default of Unity.

2. **Q:** Why use gradle version `3.1.4`?
    
    Because the versions later conflict with Android manifest file generated by the `Unity 5.6.x`.

3. **Q:** Why need use `unity.aar` and `VTCSdk.aar` together?
    
    While `VTCSdk.aar` main focus on native Android then `unity.aar` is the bridge plugin to Unity, it support callback method instead `onActivityResult` when sign in or payment.
    
    The `UnityActivity` activity in `unity.aar` will receive `onActivityResult` from `VTCSdk.aar` then send message to Unity over `PluginCallback`. **Use `unity.aar` developer don't must extends or modify `UnityPlayerActivity` class**. 
    
    (Declare line `<activity android:name="com.software.intecom.vtc.unity.UnityActivity" android:theme="@android:style/Theme.Translucent.NoTitleBar"></activity>` in the `AndroidManifest.xml` file).

4. **Q:** Why need choose Target API Level is Automatic?

    Because the `Unity 5.6.x` only support max level is 25 (`Android 7.1 (API Level 25)`) to select, in while Google Play require must target at least [Android 9 (API level 28)](https://developer.android.com/distribute/best-practices/develop/target-sdk)

5. **Q:** What is `BuildPostProcessor.cs` file? 

    `BuildPostProcessor.cs` is a build script, it will copy `sdkconfig.xml` file to `res/raw` directory of Android project.
